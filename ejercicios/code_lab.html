<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Lab - Interaktive Programmier-Lernplattform</title>

    <!-- CodeMirror f√ºr Syntax-Highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/elegant.min.css">

    <!-- Chart.js f√ºr Statistiken -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.css">

    <!-- QRCode.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <!-- Marked.js f√ºr Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Light Mode */
            --bg-primary: #ffffff;
            --bg-secondary: #f5f7fa;
            --bg-tertiary: #e8eef5;
            --text-primary: #2c3e50;
            --text-secondary: #5a6c7d;
            --accent-primary: #3498db;
            --accent-secondary: #2ecc71;
            --accent-danger: #e74c3c;
            --accent-warning: #f39c12;
            --border-color: #dce4ec;
            --shadow: rgba(0, 0, 0, 0.1);
            --code-bg: #f8f9fa;
            --console-bg: #1e1e1e;
            --console-text: #d4d4d4;
        }

        [data-theme="dark"] {
            --bg-primary: #1a1d23;
            --bg-secondary: #2a2d35;
            --bg-tertiary: #34373f;
            --text-primary: #e4e6eb;
            --text-secondary: #b0b3b8;
            --accent-primary: #4a9eff;
            --accent-secondary: #2ecc71;
            --accent-danger: #ff6b6b;
            --accent-warning: #ffd43b;
            --border-color: #3a3d45;
            --shadow: rgba(0, 0, 0, 0.3);
            --code-bg: #2a2d35;
            --console-bg: #0d1117;
            --console-text: #c9d1d9;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: background 0.3s, color 0.3s;
        }

        /* Navigation */
        .navbar {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .navbar-brand {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .navbar-menu {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-primary {
            background: var(--accent-primary);
            color: white;
        }

        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-success {
            background: var(--accent-secondary);
            color: white;
        }

        .btn-danger {
            background: var(--accent-danger);
            color: white;
        }

        .btn-icon {
            background: transparent;
            border: 1px solid var(--border-color);
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Language Selector */
        .language-selector {
            position: relative;
        }

        .language-selector select {
            padding: 0.5rem;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* View System */
        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Auth View */
        .auth-container {
            max-width: 400px;
            margin: 4rem auto;
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px var(--shadow);
        }

        .auth-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .auth-tab {
            flex: 1;
            padding: 0.75rem;
            text-align: center;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .auth-tab.active {
            border-bottom-color: var(--accent-primary);
            color: var(--accent-primary);
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 1rem;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        /* Task Selection */
        .task-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .task-card {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .task-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .task-card.active {
            border-color: var(--accent-primary);
            background: var(--accent-primary);
            color: white;
        }

        .task-card-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .task-card-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        /* Code Editor View */
        .editor-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            height: calc(100vh - 200px);
        }

        .editor-panel {
            background: var(--bg-secondary);
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            padding: 1rem;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .panel-content {
            flex: 1;
            overflow: auto;
        }

        .CodeMirror {
            height: 100% !important;
            font-size: 14px;
        }

        /* Console */
        .console {
            background: var(--console-bg);
            color: var(--console-text);
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            height: 100%;
            overflow-y: auto;
        }

        .console-line {
            margin-bottom: 0.5rem;
            padding: 0.25rem;
        }

        .console-line.error {
            color: #ff6b6b;
        }

        .console-line.success {
            color: #51cf66;
        }

        .console-line.info {
            color: #4dabf7;
        }

        /* Task Description */
        .task-description {
            padding: 1rem;
        }

        .task-description h3 {
            margin-bottom: 1rem;
            color: var(--accent-primary);
        }

        .task-description p {
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .hints-container {
            margin-top: 1rem;
        }

        .hint {
            background: var(--bg-tertiary);
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 6px;
            border-left: 3px solid var(--accent-warning);
        }

        /* Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid var(--accent-primary);
        }

        .stat-card h3 {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent-primary);
        }

        .chart-container {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-primary);
            padding: 2rem;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-close {
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--text-secondary);
        }

        /* QR Code */
        #qr-code-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        /* Alerts */
        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: rgba(46, 204, 113, 0.1);
            border: 1px solid var(--accent-secondary);
            color: var(--accent-secondary);
        }

        .alert-danger {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid var(--accent-danger);
            color: var(--accent-danger);
        }

        .alert-info {
            background: rgba(52, 152, 219, 0.1);
            border: 1px solid var(--accent-primary);
            color: var(--accent-primary);
        }

        /* Task List */
        .task-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .task-item {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s;
        }

        .task-item:hover {
            border-color: var(--accent-primary);
            transform: translateX(4px);
        }

        .task-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .task-item-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .task-item-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge-primary {
            background: var(--accent-primary);
            color: white;
        }

        .badge-success {
            background: var(--accent-secondary);
            color: white;
        }

        .badge-warning {
            background: var(--accent-warning);
            color: white;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .editor-container {
                grid-template-columns: 1fr;
            }

            .navbar {
                padding: 1rem;
            }

            .container {
                padding: 1rem;
            }

            .task-selector {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--accent-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* File Upload */
        .file-upload {
            border: 2px dashed var(--border-color);
            padding: 2rem;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload:hover {
            border-color: var(--accent-primary);
            background: var(--bg-tertiary);
        }

        .file-upload input[type="file"] {
            display: none;
        }
    </style>
</head>
<body data-theme="light">
    <!-- Navigation -->
    <nav class="navbar">
        <div class="navbar-brand">
            <span>üíª</span> Code Lab
        </div>
        <div class="navbar-menu">
            <div class="language-selector">
                <select id="language-selector" onchange="changeLanguage()">
                    <option value="de">üá©üá™ Deutsch</option>
                    <option value="en">üá¨üáß English</option>
                    <option value="es">üá™üá∏ Espa√±ol</option>
                </select>
            </div>
            <button class="btn btn-icon" id="theme-toggle" onclick="toggleTheme()">
                <span id="theme-icon">üåô</span>
            </button>
            <button class="btn btn-secondary" id="nav-dashboard" onclick="showView('dashboard')" style="display: none;">
                Dashboard
            </button>
            <button class="btn btn-danger" id="nav-logout" onclick="logout()" style="display: none;">
                Logout
            </button>
        </div>
    </nav>

    <div class="container">
        <!-- Auth View -->
        <div id="auth-view" class="view active">
            <div class="auth-container">
                <div class="auth-tabs">
                    <div class="auth-tab active" data-tab="login" onclick="switchAuthTab('login')">
                        <span data-i18n="auth.login">Anmelden</span>
                    </div>
                    <div class="auth-tab" data-tab="register" onclick="switchAuthTab('register')">
                        <span data-i18n="auth.register">Registrieren</span>
                    </div>
                </div>

                <!-- Login Form -->
                <form id="login-form" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label data-i18n="auth.username">Benutzername oder E-Mail</label>
                        <input type="text" class="form-control" id="login-username" required>
                    </div>
                    <div class="form-group">
                        <label data-i18n="auth.password">Passwort</label>
                        <input type="password" class="form-control" id="login-password" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <span data-i18n="auth.login">Anmelden</span>
                    </button>
                </form>

                <!-- Register Form -->
                <form id="register-form" style="display: none;" onsubmit="handleRegister(event)">
                    <div class="form-group">
                        <label data-i18n="auth.fullname">Vollst√§ndiger Name</label>
                        <input type="text" class="form-control" id="register-fullname" required>
                    </div>
                    <div class="form-group">
                        <label data-i18n="auth.username">Benutzername</label>
                        <input type="text" class="form-control" id="register-username" required>
                    </div>
                    <div class="form-group">
                        <label data-i18n="auth.email">E-Mail</label>
                        <input type="email" class="form-control" id="register-email" required>
                    </div>
                    <div class="form-group">
                        <label data-i18n="auth.password">Passwort</label>
                        <input type="password" class="form-control" id="register-password" required>
                    </div>
                    <div class="form-group">
                        <label data-i18n="auth.role">Ich bin...</label>
                        <select class="form-control" id="register-role" required>
                            <option value="student" data-i18n="auth.student">Sch√ºler/in</option>
                            <option value="teacher" data-i18n="auth.teacher">Lehrer/in</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <span data-i18n="auth.register">Registrieren</span>
                    </button>
                </form>

                <div id="auth-alert"></div>
            </div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboard-view" class="view">
            <h1 data-i18n="dashboard.title">Dashboard</h1>
            <div id="dashboard-content"></div>
        </div>

        <!-- Task Selection View -->
        <div id="task-select-view" class="view">
            <h1 data-i18n="tasks.my_tasks">Meine Aufgaben</h1>
            <div id="task-list" class="task-list"></div>
        </div>

        <!-- Code Editor View -->
        <div id="editor-view" class="view">
            <div style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                <button class="btn btn-secondary" onclick="showView('task-select')">
                    ‚Üê <span data-i18n="common.back">Zur√ºck</span>
                </button>
                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-success" onclick="runCode()">
                        ‚ñ∂ <span data-i18n="editor.run">Ausf√ºhren</span>
                    </button>
                    <button class="btn btn-primary" onclick="submitSolution()">
                        <span data-i18n="editor.submit">L√∂sung einreichen</span>
                    </button>
                    <button class="btn btn-secondary" onclick="showQRCode()">
                        üì± QR-Code
                    </button>
                </div>
            </div>

            <div class="editor-container">
                <div class="editor-panel">
                    <div class="panel-header">
                        <div class="panel-title" data-i18n="editor.task">Aufgabe</div>
                        <button class="btn btn-icon" onclick="showHints()">üí° Tipps</button>
                    </div>
                    <div class="panel-content">
                        <div id="task-description" class="task-description"></div>
                    </div>
                </div>

                <div class="editor-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <span data-i18n="editor.code">Code-Editor</span>
                            <span id="selected-language"></span>
                        </div>
                        <div>
                            <select id="language-picker" class="form-control" onchange="changeCodeLanguage()">
                                <option value="html">HTML</option>
                                <option value="css">CSS</option>
                                <option value="javascript">JavaScript</option>
                                <option value="python">Python</option>
                                <option value="java">Java</option>
                                <option value="git">Git</option>
                                <option value="lua">Lua</option>
                                <option value="scratch">Scratch</option>
                                <option value="makecode">MakeCode</option>
                                <option value="micropython">MicroPython</option>
                            </select>
                        </div>
                    </div>
                    <div class="panel-content">
                        <textarea id="code-editor"></textarea>
                    </div>
                </div>
            </div>

            <div class="editor-panel" style="margin-top: 1rem; height: 300px;">
                <div class="panel-header">
                    <div class="panel-title" data-i18n="editor.console">Konsole</div>
                    <button class="btn btn-icon" onclick="clearConsole()">
                        üóëÔ∏è <span data-i18n="editor.clear">L√∂schen</span>
                    </button>
                </div>
                <div class="panel-content">
                    <div id="console" class="console"></div>
                </div>
            </div>
        </div>

        <!-- Teacher Create Task View -->
        <div id="create-task-view" class="view">
            <h1 data-i18n="teacher.create_task">Aufgabe erstellen</h1>
            <div style="max-width: 800px;">
                <form id="create-task-form" onsubmit="handleCreateTask(event)">
                    <div class="form-group">
                        <label data-i18n="teacher.task_title">Aufgaben-Titel</label>
                        <input type="text" class="form-control" id="task-title" required>
                    </div>
                    <div class="form-group">
                        <label data-i18n="teacher.description">Beschreibung</label>
                        <textarea class="form-control" id="task-description-input" rows="4"></textarea>
                    </div>
                    <div class="form-group">
                        <label data-i18n="teacher.programming_language">Programmiersprache</label>
                        <select class="form-control" id="task-language" required>
                            <option value="html">HTML</option>
                            <option value="css">CSS</option>
                            <option value="javascript">JavaScript</option>
                            <option value="python">Python</option>
                            <option value="java">Java</option>
                            <option value="git">Git</option>
                            <option value="lua">Lua</option>
                            <option value="scratch">Scratch</option>
                            <option value="makecode">MakeCode</option>
                            <option value="micropython">MicroPython</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-i18n="teacher.upload_task">Aufgabe hochladen</label>
                        <div class="file-upload" onclick="document.getElementById('task-file-input').click()">
                            <input type="file" id="task-file-input" accept=".txt,.md,.pdf" onchange="handleTaskFileUpload(event)">
                            <p data-i18n="teacher.drop_file">üìÑ Datei ausw√§hlen (TXT, Markdown, PDF)</p>
                            <p id="file-name"></p>
                        </div>
                    </div>
                    <div class="form-group">
                        <label data-i18n="teacher.task_content">Aufgabeninhalt</label>
                        <textarea class="form-control" id="task-content" rows="10" required></textarea>
                    </div>
                    <div class="form-group">
                        <label data-i18n="teacher.expected_output">Erwartete Ausgabe (optional)</label>
                        <textarea class="form-control" id="task-expected" rows="4"></textarea>
                    </div>
                    <div class="form-group">
                        <label data-i18n="teacher.hints">Tipps (einer pro Zeile)</label>
                        <textarea class="form-control" id="task-hints" rows="4" placeholder="Tipp 1&#10;Tipp 2&#10;Tipp 3"></textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label data-i18n="teacher.max_points">Max. Punkte</label>
                            <input type="number" class="form-control" id="task-points" value="100" min="1" required>
                        </div>
                        <div class="form-group">
                            <label data-i18n="teacher.time_limit">Zeitlimit (Minuten)</label>
                            <input type="number" class="form-control" id="task-time" placeholder="Optional">
                        </div>
                        <div class="form-group">
                            <label data-i18n="teacher.difficulty">Schwierigkeit</label>
                            <select class="form-control" id="task-difficulty">
                                <option value="beginner">Anf√§nger</option>
                                <option value="intermediate">Fortgeschritten</option>
                                <option value="advanced">Experte</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button type="button" class="btn btn-secondary" onclick="showView('dashboard')">
                            <span data-i18n="common.cancel">Abbrechen</span>
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <span data-i18n="teacher.create">Erstellen</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qr-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 data-i18n="common.share">Teilen</h2>
                <span class="modal-close" onclick="closeModal('qr-modal')">√ó</span>
            </div>
            <div id="qr-code-container"></div>
            <div style="margin-top: 1rem;">
                <input type="text" id="share-link" class="form-control" readonly>
                <button class="btn btn-primary" style="margin-top: 0.5rem; width: 100%;" onclick="copyShareLink()">
                    <span data-i18n="common.copy_link">Link kopieren</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Hints Modal -->
    <div id="hints-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 data-i18n="editor.hints">Tipps</h2>
                <span class="modal-close" onclick="closeModal('hints-modal')">√ó</span>
            </div>
            <div id="hints-content"></div>
        </div>
    </div>

    <!-- CodeMirror -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/clike/clike.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/lua/lua.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <script>
        // Configuration
        const API_BASE = '/api'; // √Ñndern Sie dies f√ºr Produktion!

        // State
        let currentUser = null;
        let currentTask = null;
        let codeEditor = null;
        let sessionToken = localStorage.getItem('session_token');

        // Translations
        const translations = {
            de: {
                auth: {
                    login: 'Anmelden',
                    register: 'Registrieren',
                    username: 'Benutzername oder E-Mail',
                    password: 'Passwort',
                    fullname: 'Vollst√§ndiger Name',
                    email: 'E-Mail',
                    role: 'Ich bin...',
                    student: 'Sch√ºler/in',
                    teacher: 'Lehrer/in'
                },
                dashboard: {
                    title: 'Dashboard'
                },
                tasks: {
                    my_tasks: 'Meine Aufgaben'
                },
                editor: {
                    task: 'Aufgabe',
                    code: 'Code-Editor',
                    console: 'Konsole',
                    run: 'Ausf√ºhren',
                    submit: 'L√∂sung einreichen',
                    clear: 'L√∂schen',
                    hints: 'Tipps'
                },
                teacher: {
                    create_task: 'Aufgabe erstellen',
                    task_title: 'Aufgaben-Titel',
                    description: 'Beschreibung',
                    programming_language: 'Programmiersprache',
                    upload_task: 'Aufgabe hochladen',
                    drop_file: 'üìÑ Datei ausw√§hlen (TXT, Markdown, PDF)',
                    task_content: 'Aufgabeninhalt',
                    expected_output: 'Erwartete Ausgabe (optional)',
                    hints: 'Tipps (einer pro Zeile)',
                    max_points: 'Max. Punkte',
                    time_limit: 'Zeitlimit (Minuten)',
                    difficulty: 'Schwierigkeit',
                    create: 'Erstellen'
                },
                common: {
                    back: 'Zur√ºck',
                    cancel: 'Abbrechen',
                    share: 'Teilen',
                    copy_link: 'Link kopieren'
                }
            },
            en: {
                auth: {
                    login: 'Login',
                    register: 'Register',
                    username: 'Username or Email',
                    password: 'Password',
                    fullname: 'Full Name',
                    email: 'Email',
                    role: 'I am...',
                    student: 'Student',
                    teacher: 'Teacher'
                },
                dashboard: {
                    title: 'Dashboard'
                },
                tasks: {
                    my_tasks: 'My Tasks'
                },
                editor: {
                    task: 'Task',
                    code: 'Code Editor',
                    console: 'Console',
                    run: 'Run',
                    submit: 'Submit Solution',
                    clear: 'Clear',
                    hints: 'Hints'
                },
                teacher: {
                    create_task: 'Create Task',
                    task_title: 'Task Title',
                    description: 'Description',
                    programming_language: 'Programming Language',
                    upload_task: 'Upload Task',
                    drop_file: 'üìÑ Select File (TXT, Markdown, PDF)',
                    task_content: 'Task Content',
                    expected_output: 'Expected Output (optional)',
                    hints: 'Hints (one per line)',
                    max_points: 'Max Points',
                    time_limit: 'Time Limit (minutes)',
                    difficulty: 'Difficulty',
                    create: 'Create'
                },
                common: {
                    back: 'Back',
                    cancel: 'Cancel',
                    share: 'Share',
                    copy_link: 'Copy Link'
                }
            },
            es: {
                auth: {
                    login: 'Iniciar sesi√≥n',
                    register: 'Registrarse',
                    username: 'Usuario o Email',
                    password: 'Contrase√±a',
                    fullname: 'Nombre completo',
                    email: 'Email',
                    role: 'Soy...',
                    student: 'Estudiante',
                    teacher: 'Profesor/a'
                },
                dashboard: {
                    title: 'Panel de control'
                },
                tasks: {
                    my_tasks: 'Mis tareas'
                },
                editor: {
                    task: 'Tarea',
                    code: 'Editor de c√≥digo',
                    console: 'Consola',
                    run: 'Ejecutar',
                    submit: 'Enviar soluci√≥n',
                    clear: 'Limpiar',
                    hints: 'Pistas'
                },
                teacher: {
                    create_task: 'Crear tarea',
                    task_title: 'T√≠tulo de la tarea',
                    description: 'Descripci√≥n',
                    programming_language: 'Lenguaje de programaci√≥n',
                    upload_task: 'Subir tarea',
                    drop_file: 'üìÑ Seleccionar archivo (TXT, Markdown, PDF)',
                    task_content: 'Contenido de la tarea',
                    expected_output: 'Salida esperada (opcional)',
                    hints: 'Pistas (una por l√≠nea)',
                    max_points: 'Puntos m√°x.',
                    time_limit: 'L√≠mite de tiempo (minutos)',
                    difficulty: 'Dificultad',
                    create: 'Crear'
                },
                common: {
                    back: 'Volver',
                    cancel: 'Cancelar',
                    share: 'Compartir',
                    copy_link: 'Copiar enlace'
                }
            }
        };

        let currentLanguage = 'de';

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initCodeEditor();
            checkAuth();
        });

        // Theme Toggle
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', newTheme);
            document.getElementById('theme-icon').textContent = newTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
            localStorage.setItem('theme', newTheme);

            if (codeEditor) {
                codeEditor.setOption('theme', newTheme === 'light' ? 'elegant' : 'monokai');
            }
        }

        // Language Change
        function changeLanguage() {
            currentLanguage = document.getElementById('language-selector').value;
            updateTranslations();
            localStorage.setItem('language', currentLanguage);
        }

        function updateTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                const keys = key.split('.');
                let value = translations[currentLanguage];

                for (const k of keys) {
                    value = value?.[k];
                }

                if (value) {
                    el.textContent = value;
                }
            });
        }

        // Auth Functions
        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.auth-tab[data-tab="${tab}"]`).classList.add('active');

            if (tab === 'login') {
                document.getElementById('login-form').style.display = 'block';
                document.getElementById('register-form').style.display = 'none';
            } else {
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('register-form').style.display = 'block';
            }
        }

        async function handleLogin(e) {
            e.preventDefault();

            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;

            try {
                const response = await fetch(`${API_BASE}/auth.php?action=login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (data.success) {
                    sessionToken = data.data.session_token;
                    currentUser = data.data;
                    localStorage.setItem('session_token', sessionToken);
                    showAlert('Login erfolgreich!', 'success', 'auth-alert');

                    setTimeout(() => {
                        afterLogin();
                    }, 500);
                } else {
                    showAlert(data.error, 'danger', 'auth-alert');
                }
            } catch (error) {
                console.error('Login error:', error);
                showAlert('Verbindungsfehler', 'danger', 'auth-alert');
            }
        }

        async function handleRegister(e) {
            e.preventDefault();

            const fullName = document.getElementById('register-fullname').value;
            const username = document.getElementById('register-username').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const role = document.getElementById('register-role').value;

            try {
                const response = await fetch(`${API_BASE}/auth.php?action=register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        full_name: fullName,
                        username,
                        email,
                        password,
                        role,
                        preferred_language: currentLanguage
                    })
                });

                const data = await response.json();

                if (data.success) {
                    sessionToken = data.data.session_token;
                    currentUser = data.data;
                    localStorage.setItem('session_token', sessionToken);
                    showAlert('Registrierung erfolgreich!', 'success', 'auth-alert');

                    setTimeout(() => {
                        afterLogin();
                    }, 500);
                } else {
                    showAlert(data.error, 'danger', 'auth-alert');
                }
            } catch (error) {
                console.error('Register error:', error);
                showAlert('Verbindungsfehler', 'danger', 'auth-alert');
            }
        }

        async function checkAuth() {
            if (!sessionToken) {
                showView('auth');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth.php?action=verify`, {
                    headers: { 'Authorization': `Bearer ${sessionToken}` }
                });

                const data = await response.json();

                if (data.success) {
                    currentUser = data.data;
                    afterLogin();
                } else {
                    localStorage.removeItem('session_token');
                    sessionToken = null;
                    showView('auth');
                }
            } catch (error) {
                console.error('Auth check error:', error);
                showView('auth');
            }
        }

        function afterLogin() {
            document.getElementById('nav-dashboard').style.display = 'inline-block';
            document.getElementById('nav-logout').style.display = 'inline-block';

            if (currentUser.role === 'teacher') {
                loadTeacherDashboard();
            } else {
                loadStudentTasks();
            }
        }

        async function logout() {
            try {
                await fetch(`${API_BASE}/auth.php?action=logout`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${sessionToken}` }
                });
            } catch (error) {
                console.error('Logout error:', error);
            }

            localStorage.removeItem('session_token');
            sessionToken = null;
            currentUser = null;
            showView('auth');
            document.getElementById('nav-dashboard').style.display = 'none';
            document.getElementById('nav-logout').style.display = 'none';
        }

        // View Management
        function showView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));

            let targetView;
            if (viewName === 'auth') {
                targetView = 'auth-view';
            } else if (viewName === 'dashboard') {
                targetView = 'dashboard-view';
                if (currentUser.role === 'teacher') {
                    loadTeacherDashboard();
                } else {
                    loadStudentDashboard();
                }
            } else if (viewName === 'task-select') {
                targetView = 'task-select-view';
                loadStudentTasks();
            } else if (viewName === 'editor') {
                targetView = 'editor-view';
            } else if (viewName === 'create-task') {
                targetView = 'create-task-view';
            }

            document.getElementById(targetView).classList.add('active');
        }

        // Student Functions
        async function loadStudentTasks() {
            showView('task-select');

            try {
                const response = await fetch(`${API_BASE}/tasks.php`, {
                    headers: { 'Authorization': `Bearer ${sessionToken}` }
                });

                const data = await response.json();

                if (data.success) {
                    renderTaskList(data.data);
                }
            } catch (error) {
                console.error('Load tasks error:', error);
            }
        }

        function renderTaskList(tasks) {
            const container = document.getElementById('task-list');

            if (tasks.length === 0) {
                container.innerHTML = '<p>Keine Aufgaben zugewiesen.</p>';
                return;
            }

            container.innerHTML = tasks.map(task => `
                <div class="task-item" onclick="openTask(${task.id})">
                    <div class="task-item-header">
                        <div class="task-item-title">${task.title}</div>
                        <span class="badge badge-primary">${task.programming_language.toUpperCase()}</span>
                    </div>
                    <div class="task-item-meta">
                        <span>üìä ${task.max_points} Punkte</span>
                        ${task.my_best_score ? `<span>‚≠ê Beste: ${task.my_best_score}</span>` : ''}
                        ${task.deadline ? `<span>‚è∞ ${new Date(task.deadline).toLocaleDateString()}</span>` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function openTask(taskId) {
            try {
                const response = await fetch(`${API_BASE}/tasks.php?id=${taskId}`, {
                    headers: { 'Authorization': `Bearer ${sessionToken}` }
                });

                const data = await response.json();

                if (data.success) {
                    currentTask = data.data;
                    setupEditor(currentTask);
                    showView('editor');
                }
            } catch (error) {
                console.error('Open task error:', error);
            }
        }

        // Teacher Functions
        async function loadTeacherDashboard() {
            showView('dashboard');

            try {
                const response = await fetch(`${API_BASE}/results.php?action=dashboard`, {
                    headers: { 'Authorization': `Bearer ${sessionToken}` }
                });

                const data = await response.json();

                if (data.success) {
                    renderTeacherDashboard(data.data);
                }
            } catch (error) {
                console.error('Load dashboard error:', error);
            }
        }

        function renderTeacherDashboard(dashboardData) {
            const container = document.getElementById('dashboard-content');

            container.innerHTML = `
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <h3>Aufgaben gesamt</h3>
                        <div class="stat-value">${dashboardData.overview.total_tasks || 0}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Sch√ºler gesamt</h3>
                        <div class="stat-value">${dashboardData.overview.total_students || 0}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Einreichungen</h3>
                        <div class="stat-value">${dashboardData.overview.total_submissions || 0}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Durchschnitt</h3>
                        <div class="stat-value">${Math.round(dashboardData.overview.avg_score || 0)}%</div>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="showView('create-task')" style="margin-bottom: 2rem;">
                    + Neue Aufgabe erstellen
                </button>

                <div class="chart-container">
                    <h2>Letzte Einreichungen</h2>
                    <div class="task-list">
                        ${dashboardData.recent_submissions.map(sub => `
                            <div class="task-item">
                                <div class="task-item-header">
                                    <div class="task-item-title">${sub.task_title}</div>
                                    <span class="badge ${sub.is_passed ? 'badge-success' : 'badge-warning'}">
                                        ${sub.points_earned}/${sub.max_points}
                                    </span>
                                </div>
                                <div class="task-item-meta">
                                    <span>üë§ ${sub.full_name}</span>
                                    <span>üìÖ ${new Date(sub.submitted_at).toLocaleString()}</span>
                                </div>
                            </div>
                        `).join('') || '<p>Keine Einreichungen vorhanden.</p>'}
                    </div>
                </div>
            `;
        }

        async function loadStudentDashboard() {
            // Simplified student dashboard
            showView('task-select');
            loadStudentTasks();
        }

        // Editor Functions
        function initCodeEditor() {
            const textarea = document.getElementById('code-editor');
            codeEditor = CodeMirror.fromTextArea(textarea, {
                lineNumbers: true,
                mode: 'javascript',
                theme: document.documentElement.getAttribute('data-theme') === 'dark' ? 'monokai' : 'elegant',
                indentUnit: 4,
                tabSize: 4,
                lineWrapping: true
            });
        }

        function setupEditor(task) {
            document.getElementById('task-description').innerHTML = `
                <h3>${task.title}</h3>
                <p>${task.description || ''}</p>
                <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 6px; margin-top: 1rem;">
                    ${marked.parse(task.task_content)}
                </div>
            `;

            document.getElementById('selected-language').textContent = `(${task.programming_language})`;
            document.getElementById('language-picker').value = task.programming_language;

            const modeMap = {
                html: 'htmlmixed',
                css: 'css',
                javascript: 'javascript',
                python: 'python',
                java: 'text/x-java',
                lua: 'lua',
                git: 'shell',
                scratch: 'javascript',
                makecode: 'javascript',
                micropython: 'python'
            };

            codeEditor.setOption('mode', modeMap[task.programming_language] || 'javascript');
            codeEditor.setValue('');
            clearConsole();
        }

        function changeCodeLanguage() {
            const lang = document.getElementById('language-picker').value;
            const modeMap = {
                html: 'htmlmixed',
                css: 'css',
                javascript: 'javascript',
                python: 'python',
                java: 'text/x-java',
                lua: 'lua',
                git: 'shell',
                scratch: 'javascript',
                makecode: 'javascript',
                micropython: 'python'
            };

            codeEditor.setOption('mode', modeMap[lang] || 'javascript');
        }

        function runCode() {
            const code = codeEditor.getValue();
            const language = document.getElementById('language-picker').value;

            clearConsole();
            addConsoleMessage('‚ñ∂ Code wird ausgef√ºhrt...', 'info');

            // Simulate execution for browser-compatible languages
            if (language === 'javascript') {
                try {
                    const originalLog = console.log;
                    console.log = (...args) => {
                        addConsoleMessage(args.join(' '), 'success');
                        originalLog.apply(console, args);
                    };

                    eval(code);
                    console.log = originalLog;
                } catch (error) {
                    addConsoleMessage('‚ùå Error: ' + error.message, 'error');
                }
            } else if (language === 'html' || language === 'css') {
                addConsoleMessage('‚úì HTML/CSS validiert', 'success');
                addConsoleMessage('‚Ñπ F√ºr echte Vorschau bitte separates Fenster verwenden', 'info');
            } else {
                addConsoleMessage(`‚Ñπ ${language.toUpperCase()} wird simuliert`, 'info');
                addConsoleMessage('‚úì Syntax scheint korrekt', 'success');
            }
        }

        async function submitSolution() {
            const code = codeEditor.getValue();

            if (!code.trim()) {
                alert('Bitte Code eingeben!');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/results.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionToken}`
                    },
                    body: JSON.stringify({
                        task_id: currentTask.id,
                        code_solution: code,
                        execution_output: document.getElementById('console').innerText,
                        time_spent: 0 // Could track real time
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert(`L√∂sung eingereicht!\nPunkte: ${data.data.points_earned}/${data.data.max_points}`);
                } else {
                    alert('Fehler: ' + data.error);
                }
            } catch (error) {
                console.error('Submit error:', error);
                alert('Verbindungsfehler');
            }
        }

        function clearConsole() {
            document.getElementById('console').innerHTML = '';
        }

        function addConsoleMessage(message, type = '') {
            const console = document.getElementById('console');
            const line = document.createElement('div');
            line.className = `console-line ${type}`;
            line.textContent = message;
            console.appendChild(line);
            console.scrollTop = console.scrollHeight;
        }

        function showHints() {
            if (!currentTask || !currentTask.hints || currentTask.hints.length === 0) {
                alert('Keine Tipps verf√ºgbar');
                return;
            }

            const content = document.getElementById('hints-content');
            content.innerHTML = currentTask.hints.map((hint, i) => `
                <div class="hint">
                    <strong>Tipp ${i + 1}:</strong> ${hint}
                </div>
            `).join('');

            document.getElementById('hints-modal').classList.add('active');
        }

        // QR Code
        function showQRCode() {
            if (!currentTask) return;

            const shareLink = `${window.location.origin}${window.location.pathname}?task=${currentTask.share_code}`;

            document.getElementById('qr-code-container').innerHTML = '';
            new QRCode(document.getElementById('qr-code-container'), {
                text: shareLink,
                width: 256,
                height: 256
            });

            document.getElementById('share-link').value = shareLink;
            document.getElementById('qr-modal').classList.add('active');
        }

        function copyShareLink() {
            const input = document.getElementById('share-link');
            input.select();
            document.execCommand('copy');
            alert('Link kopiert!');
        }

        // Task Creation
        async function handleCreateTask(e) {
            e.preventDefault();

            const hints = document.getElementById('task-hints').value
                .split('\n')
                .filter(h => h.trim())
                .map(h => h.trim());

            const taskData = {
                title: document.getElementById('task-title').value,
                description: document.getElementById('task-description-input').value,
                programming_language: document.getElementById('task-language').value,
                task_content: document.getElementById('task-content').value,
                expected_output: document.getElementById('task-expected').value,
                hints: hints,
                max_points: parseInt(document.getElementById('task-points').value),
                time_limit: document.getElementById('task-time').value ? parseInt(document.getElementById('task-time').value) : null,
                difficulty: document.getElementById('task-difficulty').value,
                task_type: 'markdown'
            };

            try {
                const response = await fetch(`${API_BASE}/tasks.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionToken}`
                    },
                    body: JSON.stringify(taskData)
                });

                const data = await response.json();

                if (data.success) {
                    alert(`Aufgabe erstellt!\nShare-Code: ${data.data.share_code}`);
                    showView('dashboard');
                } else {
                    alert('Fehler: ' + data.error);
                }
            } catch (error) {
                console.error('Create task error:', error);
                alert('Verbindungsfehler');
            }
        }

        async function handleTaskFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('file-name').textContent = file.name;

            const fileType = file.name.split('.').pop().toLowerCase();

            if (fileType === 'pdf') {
                // PDF.js processing
                const reader = new FileReader();
                reader.onload = async function(event) {
                    const typedArray = new Uint8Array(event.target.result);
                    const pdf = await pdfjsLib.getDocument(typedArray).promise;

                    let text = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        text += content.items.map(item => item.str).join(' ') + '\n';
                    }

                    document.getElementById('task-content').value = text;
                };
                reader.readAsArrayBuffer(file);
            } else {
                // Text/Markdown
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('task-content').value = event.target.result;
                };
                reader.readAsText(file);
            }
        }

        // Modal Functions
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Utility
        function showAlert(message, type, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;

            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // Load saved preferences
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            document.documentElement.setAttribute('data-theme', savedTheme);
            document.getElementById('theme-icon').textContent = savedTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
        }

        const savedLanguage = localStorage.getItem('language');
        if (savedLanguage) {
            currentLanguage = savedLanguage;
            document.getElementById('language-selector').value = savedLanguage;
            updateTranslations();
        }
    </script>
</body>
</html>
